<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slimer - Game</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    
    <script type="module">
        import Feedback from "./feedback.js"
        import {LevelLoader} from "https://unpkg.com/type3games-engine/engine.js"
        import {Event} from "https://unpkg.com/type3games-engine/coretools.js"
            console.log(LevelLoader);
            Feedback.load();
            window.loader = new LevelLoader({pathPrefix:"",levelList:["levelNamedTutorial","level","level3","level1","level2","level4","level5","level6","level7","level8","leveltest","leveltest2","leveltest3"]})
            Event.on("DefaultSettingsJSONLoaded",()=>{
                loader.loadJSON("./levelNamedTutorial.json")
            })
            loader.loadDefaultFromJSON("./levelSettings.json")
            let time = 0;
            window.level = null;
            let totalTime = 0;
            
            // Restart current level: emit End and reload the level JSON
            window.restart = ()=> {
                Event.emit("End");
                if (loader && level && level.name) {
                    loader.loadJSON(`./${level.name}.json`);
                }
                 let backBtn = document.getElementById("back-btn");
                // if (!backBtn && canvas) {
                   if (backBtn) {
                        backBtn.remove();  
                   }
            }
            
            Event.on("LevelLoading",(lvl)=>{
                level = lvl;
                totalTime += time;
                time = 0;
            })
            
            Event.on("Frame",(deltaTime)=>{
                time+=deltaTime;
                if (time>level.maxTime){
                    restart();
                }
                
            })

            Event.on("RenderHUD",(ctx,canvas)=>{
                ctx.fillStyle = "black"
                ctx.font = "100px FieldGuide, sans-serif"
                let timeToRender = level.maxTime - time 
                timeToRender = Math.floor(timeToRender*1000)/1000
                     ctx.fillText(`${timeToRender}`,canvas.width-300,100)
                     ctx.font = "20px FieldGuide, sans-serif"
                     ctx.fillText(`level name: ${level.name}`,canvas.width-300,130)
                // Draw Back button on the left side of the screen
                let backBtn = document.getElementById("back-btn");
                if (!backBtn && canvas) {
                   
                    backBtn = document.createElement("button");
                    backBtn.id = "back-btn";
                    backBtn.className = "menu-btn";
                    backBtn.textContent = "Restart";
                    // Keep the button visible on the left side of the viewport
                    backBtn.style.position = "fixed";
                    backBtn.style.left = "20px";
                    backBtn.style.bottom = "20px";
                    backBtn.style.zIndex = 1000;
                    document.body.appendChild(backBtn);
                    backBtn.onclick = () => restart();
                } else if (backBtn && canvas) {
                    // Ensure it remains fixed on the left side if already created
                    
                    backBtn.style.position = "fixed";
                    backBtn.style.left = "20px";
                    backBtn.style.bottom = "20px";
                    backBtn.style.zIndex = 1000;
                }
                
            })

            Event.on("NoMoreLevels",()=>{
                totalTime += time;
                Event.emit("End")
                let backBtn = document.getElementById("back-btn");
                // if (!backBtn && canvas) {
                   if (backBtn) {
                        backBtn.remove();  
                   }
                let h1 = document.createElement("h1");
                let a = document.createElement("a");
                let button =document.createElement("button");
                button.className = "menu-btn"
                button.innerText = "Retry"
                a.href = "./index.html"
                a.appendChild(button)
                let button2 =document.createElement("button");
                button2.className = "menu-btn"
                button2.innerText = "Feedback"
                let a2 = document.createElement("a");
                a2.href = Feedback.url
                a2.target="_blank"
                a2.appendChild(button2)
                h1.innerHTML = `You Win!<br>in ${Math.floor((totalTime)*1000)/1000}s`;
                document.body.appendChild(h1)
                document.body.appendChild(a);
                document.body.appendChild(a2);
            })

            let title =document.querySelector("title")
            // Event.on("NextLevel",()=>{
            //     console.log(`time:${time}s`)
            //     title.innerHTML = `time:${time}s`
            //     time = 0;
            // })
            // Event.on("MaxSpeedReached",()=>{
            //     console.log(`MaxSpeedReached!`)
            // })
    </script>
    <script src="casm.js" type="module"></script>
</body>
</html>